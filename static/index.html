<html>

<head>
    <title>ᑎOᖇᑎᔕ ||| OᑎᒪIᑎE</title>
    <style>
        .norns {
    background-color: #AAA9AD;
width: 1050px;
height: 600px;
border-radius: 10px;
box-shadow: 10px 10px #999;
}
.hints, .text {
font-family:"Lucida Console", Monaco, monospace;
padding-top: 1em;
font-size:1.5em;
}
#playerdiv {
padding-top: 10px
}
.hidden {
display: none;
}
.nornsimage {
position: absolute;
left: 60px;
top: 250px;
background-color: #000;
width: 550px;
height: 270px;
padding: 20px;
border-radius: 10px;
border-color: #222222;
box-shadow: -1px -1px #222222;
}
.k0 {
position: absolute;
left: 95px;
top: 125px;
}
.k1 {
position: absolute;
left: 700px;
top: 475px;
}
.k2 {
position: absolute;
left: 855px;
top: 475px;
}
.button {
width: 60px;
height: 60px;
font-size: 24px;
text-align: center;
cursor: pointer;
outline: none;
color: #fff;
background-color: #222222;
border: none;
border-radius: 50%;
box-shadow: 2px 12px #999;
}
.button:active {
box-shadow: 0 5px #666;
transform: translateY(4px);
}
.latched {
box-shadow: 0 5px #666;
transform: translateY(4px);
}
.enc1knob {
position: absolute;
left: 200px;
top: 100px;
}
.enc2knob {
position: absolute;
left: 750px;
top: 300px;
}
.enc3knob {
position: absolute;
left: 905px;
top: 300px;
} 
</style>
</head>

<body>
    <div class="center">
        <div class="norns">
            <div class="nornsimage">
                <a href="/" target="_blank" class="twitch"><img id="img" src="/img/sleep.png" style="filter: brightness(1);"></a>
            </div>
            <button class="button k0" id="k0"></button>
            <button class="button k1" id="k1"></button>
            <button class="button k2" id="k2"></button>
            <div class="enc1knob">
                <input type="text" value="75" class="enc0" data-width="100" data-displayInput=false data-cursor=true data-fgColor="#fff" data-bgColor="#222222" data-thickness=1 data-curosr=1>
            </div>
            <div class="enc2knob">
                <input type="text" value="75" class="enc1" data-width="100" data-displayInput=false data-cursor=true data-fgColor="#fff" data-bgColor="#222222" data-thickness=1 data-curosr=1>
            </div>
            <div class="enc3knob">
                <input type="text" value="75" class="enc2" data-width="100" data-displayInput=false data-cursor=true data-fgColor="#fff" data-bgColor="#222222" data-thickness=1 data-curosr=1>
            </div>
        </div>
        <script src="https://player.twitch.tv/js/embed/v1.js"></script>
        <div id="livestream">
            <div style="padding-top:1em" class="text">live stream:</div>
            <div id="playerdiv"></div>
        </div>
        <div class="hints">
            <div>hints:</div>
            <ul>
                <li>k1 latches so you can use it as a shift.</li>
                <li>double click k1 to get into/out-of menu.</li>
                <li>get instructions for your own norns on <a href="https://github.com/schollz/norns.online">github</a></li>
            </ul>
        </div>
    </div>
    <script src="/js/jquery-3.5.1.min.js"></script>
    <script src="/js/jquery.knob.min.js"></script>
    <script>
        var socket;
    var norns_id = window.location.pathname.substr(1);
    if (norns_id.length < 1) {
        norns_id = window.location.hash.substr(1);
    }
    console.log(norns_id);

    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            var context = this,
                args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    var twitchActivated = false;
    var keys = [];
    var encs = [];

    function currentTime() {
        return (new Date()).getTime();
    }

    encs = [0, 1, 2].map(function(i) {
        let last_time = currentTime();
        let value = 0;
        let z = 0;
        let consecutive_turns = 0;
        return {
            change: function(v) {
                increased = v > value
                dif = 0;
                if (Math.abs(value - v) > 50) {
                    increased = !increased;
                } else {
                    dif = (v - value);
                }
                value = v;
                if (currentTime() - last_time < 500) {
                    consecutive_turns = consecutive_turns + dif;
                    return
                }
                var multiplier = 1;
                if (Math.abs(consecutive_turns) > 64) {
                    multiplier = 3;
                } else if (Math.abs(consecutive_turns) > 30) {
                    multiplier = 2;
                }
                consecutive_turns = 0;

                last_time = currentTime()
                if (increased) {
                    z = 1 * multiplier;
                    console.log(i + " increased " + z)
                } else {
                    z = -1 * multiplier;
                    console.log(i + " decreased " + z)
                }
                if (norns_id.length > 0) {
                    $.post("https://duct.schollz.com/norns.online." + norns_id + "?pubsub=true", btoa(JSON.stringify({ kind: "enc", n: i + 1, z: z })))
                }
            },
            val: function() {
                return z;
            }
        }
    });

    keys = [0, 1, 2].map(function(i) {
        let last_time = currentTime();
        let value = 0;
        let fast_clicked = false;
        return {
            reset: function() {
                value = 0;
                $("#k" + i).removeClass("latched")
                $.post("https://duct.schollz.com/norns.online." + norns_id, btoa(JSON.stringify({ kind: "key", n: i + 1, z: value })));
            },
            change: function() {
                console.log(i + " clicked")
                value = 1 - value;
                $("#k" + i).toggleClass("latched")
                if (currentTime() - last_time < 500 && value == 0) {
                    console.log("fast click!")
                    fast_clicked = true
                } else {
                    console.log("slow click")
                    fast_clicked = false
                }
                last_time = currentTime();
                if (norns_id.length > 0) {
                    if (i == 0) {
                        $.post("https://duct.schollz.com/norns.online." + norns_id, btoa(JSON.stringify({ kind: "key", n: i + 1, z: value, fast: fast_clicked })));
                    } else if (value > 0) {
                        $.post("https://duct.schollz.com/norns.online." + norns_id, btoa(JSON.stringify({ kind: "key", n: i + 1, z: value })));
                    }
                }
            },
            val: function() {
                return value;
            },
            get_fast_clicked: function() {
                return fast_clicked;
            }
        }
    });

    for (var i = 0; i < 3; i++) {
        $(`.enc${i}`).knob({
            'change': encs[i].change,
        });
        if (i == 0) {
            document.getElementById("k" + i).addEventListener("click", keys[i].change);
            //     document.getElementById("k" + i).addEventListener("mouseleave", keys[i].reset);
        } else {
            document.getElementById("k" + i).addEventListener("mousedown", keys[i].change);
            document.getElementById("k" + i).addEventListener("mouseup", keys[i].change);
        }
    }
    async function execute1() {
        while (true) {
            postResult = await $.get("https://duct.schollz.com/norns.online." + norns_id + ".png").promise();
            data = await JSON.parse(atob(postResult));
            if ('img' in data) {
                await document.getElementById('img').setAttribute(
                    'src',
                    'data:image/png;base64,' + data['img']
                )
            }
            if ('twitch' in data) {
                if (data['twitch']) {
                    await $("#livestream").removeClass("hidden");
                    if (!twitchActivated) {
                        twitchActivated = true;
                        $(".twitch").attr("href", "https://www.twitch.tv/" + norns_id)
                        var options = {
                            width: 1050,
                            height: 200,
                            channel: norns_id,
                            parent: ["norns.online"]
                        };
                        var player = new Twitch.Player("playerdiv", options);
                        player.setVolume(0.5);
                    }
                } else {
                    await $("#livestream").addClass("hidden");
                }
            }
        }
    }
    if (norns_id.length > 0) {
        execute1();

                
        const socketMessageListener = (e) => {
            d = JSON.parse(e.data);
            if ("data" in d) {
                postResult = d["data"];
                data = JSON.parse(atob(postResult));
                document.getElementById('img').setAttribute(
                    'src',
                    'data:image/png;base64,' + data['img']
                )
            }
        };
        const socketOpenListener = (e) => {
            console.log('Connected');
            socket.send(JSON.stringify({ "group": norns_id }))
        };
        const socketErrorListener = (e) => {
            console.error(e);
        }
        const socketCloseListener = (e) => {
            if (socket) {
                console.log('Disconnected.');
            }
            var url = window.origin.replace("http", "ws") + '/ws';
            socket = new WebSocket(url);
            socket.onopen = socketOpenListener;
            socket.onmessage = socketMessageListener;
            socket.onclose = socketCloseListener;
            socket.onerror = socketErrorListener;
        };
        window.addEventListener('load', (event) => {
            socketCloseListener();
        });
    }


    </script>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</body>

</html>